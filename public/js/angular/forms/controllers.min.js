'use strict';(function(){angular.module('forms.controllers',[]).filter('propsFilter',function(){return function(a,b){var d=[];if(angular.isArray(a)){var f=Object.keys(b);a.forEach(function(g){for(var h=!1,k=0;k<f.length;k++){var l=f[k],m=b[l].toLowerCase();if(-1!==g[l].toString().toLowerCase().indexOf(m)){h=!0;break}}h&&d.push(g)})}else d=a;return d}}).controller('indexController',['$scope','restService','notificationService','$builder','$validator','$window','$timeout',function(a,b,d,f,g,h,k){a.initial=0,a.page=1,a.previewShow=!1,a.input=[],a.forward=function(){a.initial+=1,a.page+=1,a.listForms()},a.fastforward=function(){a.initial=a.list.total_pages-1,a.page=a.list.total_pages,a.listForms()},a.backward=function(){a.initial-=1,a.page-=1,a.listForms()},a.fastbackward=function(){a.initial=0,a.page=1,a.listForms()},a.listForms=function(){b.listForms(a.initial,a.filter).then(function(m){a.list=m})},a.listForms(),a.filter={},a.filtername=function(){b.listForms(a.initial,a.filter).then(function(m){a.list=m})},a.openModal=function(m){a.idForm=m,$('#deleteDialog').addClass('dialog--open')},a.closeModal=function(){$('#deleteDialog').removeClass('dialog--open')},a.deleteForm=function(){b.deleteForm({idForm:a.idForm}).then(function(m){d.warning(m.message),a.listForms()}),a.closeModal()},a.translateType=function(m){return'suscription'===m?'Suscripci\xF3n':'updating'===m?'Actualizaci\xF3n':void 0},function(){b.getAllFormCategory().then(function(m){a.category=m})}(),a.previsualizar=function(m){a.previewShow=!1;var n=JSON.parse(a.list.items[m].content.content);f.setForm('sigmaForm',n.form),$('#preview').addClass('dialog--open'),a.backgroundForm=n.background,k(function(){a.previewShow=!0},1e3)},a.validateForm=function(){$validator.validate(a,'sigmaForm').success(function(){}).error(function(){})},a.codeHtml=function(m){$('#codeHtml').addClass('dialog--open'),a.codeHtmlString=angular.copy(a.list.items[m].html)},a.codeIframe=function(m){$('#iframe').addClass('dialog--open'),a.codeIframeString=angular.copy(a.list.items[m].iframe)},a.removeDialog=function(m){$('#'+m).removeClass('dialog--open')},a.reloadEditForm=function(m){h.location.href=fullUrlBase+templateBase+'/create#/basicinformation/'+m}}]).controller('createBasicInformationController',['$scope','restService','notificationService','$window','$state','$stateParams','$rootScope',function(a,b,d,f,g,h,k){function l(){b.getAllFormCategory().then(function(m){a.category=m})}a.data={},a.data.doubleOptin={},a.data.mailWelcome={},a.data.notification={},a.showInputCate=!1,a.showSelectCate=!0,a.showIconsCate=!0,a.showIconsSaveCate=!1,a.changeStatusInputCate=function(){a.showInputCate?(a.showInputCate=!1,a.showSelectCate=!0,a.showIconsCate=!0,a.showIconsSaveCate=!1):(a.showInputCate=!0,a.showSelectCate=!1,a.showIconsCate=!1,a.showIconsSaveCate=!0)},a.saveBasicInformation=function(){'undefined'!=typeof h.id&&''!=h.id?b.updatebasicinformation(h.id,a.data).then(function(){d.success('Se ha creado la informaci\xF3n basica del formulario'),g.go('create.forms',{id:h.id})}):b.saveBasicInformation(a.data).then(function(m){d.success('Se ha creado la informaci\xF3n basica del formulario'),g.go('create.forms',{id:m.idForm})})},a.previewmailtempcont=function(m){m&&b.previewMailTemplateContent(m).then(function(n){var o=n.template;document.getElementById('preview-modal').innerHTML='',$('<iframe frameborder="0" width="100%" height="100%"/>').appendTo('#preview-modal').contents().find('body').append(o),$('#myModal').modal('show')})},a.getContactList=function(){b.getContactlist().then(function(m){a.contactlist=m})},l();a.saveCategory=function(){var m={category:a.nameCategory};b.addFormCategory(m).then(function(n){d.success(n.msg),a.nameCategory='',l(),a.changeStatusInputCate(),a.data.idFormCategory=n.idFormCategory})},a.getMailTemplate=function(m){m?b.getallmailtemplatebyfilter(m).then(function(n){a.mailtemplate=n}):b.getMailTemplate().then(function(n){a.mailtemplate=n})},'undefined'!=typeof h.id&&''!=h.id?(k.idForm=h.id,b.getInformationForm(h.id).then(function(m){a.data=m,a.data.idFormCategory=m.idFormCategory,a.data.doubleOptin={},a.data.mailWelcome={},a.data.notification={},1==m.optin&&b.getOptin(h.id).then(function(n){!1!=n&&(a.data.doubleOptin=n,a.data.doubleOptin.active=!0,$('#divdoubleOptin').collapse('show'))}),1==m.welcomeMail&&b.getWelcomeMail(h.id).then(function(n){!1!=n&&(a.data.mailWelcome=n,a.data.mailWelcome.active=!0,$('#divwelcome').collapse('show'))}),1==m.notificationMail&&b.getNotification(h.id).then(function(n){!1!=n&&(a.data.notification=n,a.data.notification.active=!0,$('#divnotification').collapse('show'))}),a.getContactList(),a.getMailTemplate()}).catch(function(){g.go('create.describe')})):(a.getContactList(),a.getMailTemplate())}]).controller('formsController',['$scope','restService','notificationService','$builder','$validator','$q','$stateParams','$state','$window','$rootScope','$injector',function(a,b,d,f,g,h,k,l,m,n,o){o.get('$drag').setConfigData('droppables',{}),n.idForm=k.id,a.input=[],f.setForm('default',[]),a.db=!1,a.complet=!1,a.arrFields=[{selected:!1,id:'name',title:'Nombre',input:'textInput',field:'primary'},{selected:!1,id:'lastname',title:'Apellido',input:'textInput',field:'primary'},{selected:!1,id:'birthdate',title:'Fecha Nacimiento',input:'dateInput',field:'primary',validation:'[fecha]'},{selected:!1,id:'email',title:'Correo',input:'textInput',field:'primary',objExt:{noDeleted:!0}},{selected:!1,id:'indicative',title:'Indicativo',input:'select',field:'primary',objExt:{noOptions:!0,dependence:'phone'}},{selected:!1,id:'phone',title:'Telefono',input:'numberInput',field:'primary',validation:'[numberEnteros]',objExt:{noOptions:!0,dependence:'indicative'}},{selected:!1,id:'encabezado',title:'Nombre de formulario',input:'encabezado',field:'encabezado'}],a.init=function(){b.getcontentform(k.id).then(function(p){var q=JSON.parse(p.content);a.backgroundForm=q.background,f.setForm('default',q.form),a.form=f.forms['default'],a.db=!0,a.initWatch(),a.getIndicative(),a.setConfigScope(q)}).catch(function(){f.addFormObject('default',{id:'button',component:'button',label:'Aceptar',description:'',placeholder:'button',required:!0,editable:!0,objExt:{fontOrien:'center'}}),a.form=f.forms['default'],a.initWatch(),a.getIndicative()})},a.setConfigScope=function(p){'undefined'!=typeof p.background&&(a.backgroundForm=p.background),'undefined'!=typeof p.fontForm&&(a.fontForm=p.fontForm),'undefined'!=typeof p.sizeForm&&(a.sizeForm=p.sizeForm),'undefined'!=typeof p.fontStyle&&(a.fontStyle=p.fontStyle)},a.arrDirective=[],a.addComponent=function(p){var q={},r={};if(!p.selected&&(p.selected=!0,angular.isDefined(p.objExt)&&(q=p.objExt),'dateInput'==p.input&&(q={openen:!1}),angular.isDefined(a.fontForm)&&(q.fontColor=a.fontForm),angular.isDefined(a.sizeForm)&&(q.sizeStyle=a.sizeForm),angular.isDefined(a.fontStyle)&&(q.fontStyle=a.fontStyle),'encabezado'==p.input&&(p.title='Nombre de formulario',q={sizeStyle:'24px',fontOrien:'center'}),r={id:p.id,component:p.input,label:p.title,description:'',placeholder:p.title,required:!0,editable:!0,objExt:q},'email'==p.id&&(r.objExt.validationOptionsHide=!0,r.validation='[email]'),'undefined'!=typeof p.validation&&(r.validation=p.validation),'checkbox'==p.input?angular.isDefined(p.valueDefault)&&('string'==typeof p.valueDefault?r.options=p.valueDefault.split(','):r.options=p.valueDefault):'select'==p.input&&angular.isDefined(p.valueDefault)&&('string'==typeof p.valueDefault?r.options=p.valueDefault.split(','):r.options=p.valueDefault),f.addFormObject('default',r),'undefined'!=typeof p.objExt&&'undefined'!=typeof p.objExt.dependence)){var t=!1;for(var u in a.form)a.form[u].id==p.objExt.dependence&&(t=!0);if(!t)for(var u in a.arrFields)a.arrFields[u].id==p.objExt.dependence&&a.addComponent(a.arrFields[u])}},a.initWatch=function(){a.$watch('form',function(p,q){q.length>p.length&&a.compareArrayObject(q,p,'id').then(function(r){for(var t in r)for(var u=0;u<a.arrFields.length;u++)a.arrFields[u].id==r[t].id&&(a.arrFields[u].selected=!1)})},!0)},a.compareArrayObject=function(p,q,r){var t=h.defer(),u=[];for(var v in p){var w=p[v];if(angular.isDefined(w[r])){var z=!1;for(var A in q){var B=q[A];w[r]==B[r]&&(z=!0)}z||u.push(w)}}return t.resolve(u),t.promise},a.setValueArrObj=function(p,q,r){var t=h.defer(),u=[];for(var v in p){var w=p[v];if(angular.isDefined(w[r]))for(var z in q){var A=q[z];w[r]==A[r]&&u.push(w)}}return t.resolve(u),t.promise},a.getCustomField=function(){b.getCustomfield(a.idContactList).then(function(p){for(var q in p){var r=p[q].alternativename,t=p[q].name,u;switch(p[q].type){case'Text':u='textInput';break;case'Date':u='dateInput';break;case'Numerical':u='numberInput';break;case'TextArea':u='textArea';break;case'Multiselect':u='checkbox';break;case'Select':u='select';}a.arrFields.push({selected:!1,id:r,title:t,input:u,field:'custom',valueDefault:p[q].value})}for(var q in a.form)for(var v in a.arrFields)a.arrFields[v].id==a.form[q].id&&(a.arrFields[v].selected=!0)})},a.getIndicative=function(){b.getAllIndicative().then(function(p){var q=[];for(var r in p)1!=p[r].phonecode&&0!=p[r].phonecode&&''!=p[r].phonecode&&q.push('(+'+p[r].phonecode+') '+p[r].name);if(a.getCustomField(),!a.db)for(var r in a.arrFields)'indicative'==a.arrFields[r].id&&(a.arrFields[r].valueDefault=q),a.addComponent(a.arrFields[r]);a.complet=!0})},a.configForm=function(p,q){f.updateConfig('default',p,q)},a.AddForm=function(){a.searchObjArray(a.form,'id','email').then(function(p){p||d.warning('El formulario debe tener por lo menos el correo');var q=angular.isDefined(a.backgroundForm)?a.backgroundForm:null,r={form:a.form,background:q};'undefined'!=typeof a.backgroundForm&&(r.background=a.backgroundForm),'undefined'!=typeof a.fontForm&&(r.fontForm=a.fontForm),'undefined'!=typeof a.sizeForm&&(r.sizeForm=a.sizeForm),'undefined'!=typeof a.fontStyle&&(r.fontStyle=a.fontStyle),b.saveForm(k.id,r).then(function(){l.go('list')})})},a.searchObjArray=function(p,q,r){var t=h.defer();for(var v in p)if(p[v][q]==r){break}return t.resolve(!0),t.promise},angular.isUndefined(k.id)||''==k.id?l.go('create.describe'):b.getInformationForm(k.id).then(function(p){a.idContactList=p.idContactlist,a.init()}).catch(function(){l.go('create.describe',{id:n.idForm}),d.warning('El formulario no tiene una lista de contacto asignada.')})}]).controller('ContactsController',['$scope','restService','notificationService','$stateParams','$state',function(a,b,d,f,g){a.show=!0,a.showList=!0,a.contactlist=[{}],a.selected=[],a.progressbar=!1,a.changestatus=!0,a.showStatus=function(h,k){var l=[];return angular.forEach(h,function(m){angular.forEach(k,function(n){m==n&&l.push(m)})}),l.length?l.join(', '):'empty'},a.updateUser=function(h,k,l){b.editContact(l,k,h,a.idContactlist).then(function(m){d.primary(m.message),a.getAll()}).catch(function(m){d.error(m.message),a.getAll()})},a.stringfieldsprimary=function(h){var k=h;return'name'===h?k='Nombre':'lastname'===h?k='Apellido':'email'===h?k='Correo electronico':'phone'===h?k='Telefono':'birthdate'===h?k='Fecha de cumplea\xF1os':'indicative'===h?k='Indicativo':'description'===h?k='Descripci\xF3n':void 0,k},a.stringsearch=-1,a.searchcontacts=function(){a.stringsearch=a.search,a.getAll()},a.initial=0,a.page=1,a.forward=function(){a.progressbar=!1,a.initial+=1,a.page+=1,a.getAll()},a.fastforward=function(){a.progressbar=!1,a.initial=a.contacts.total_pages-1,a.page=a.contacts.total_pages,a.getAll()},a.backward=function(){a.progressbar=!1,a.initial-=1,a.page-=1,a.getAll()},a.fastbackward=function(){a.progressbar=!1,a.initial=0,a.page=1,a.getAll()},a.getAll=function(){a.progressbar=!1,b.getInformationForm(a.idForm).then(function(h){a.idContactlist=h.idContactlist,b.getAll(a.initial,a.idContactlist,a.idForm,a.stringsearch).then(function(k){0==k.total?(a.loading=!0,a.show=!1,a.showList=!0):(a.loading=!1,a.show=!0,a.showList=!1),a.contacts=k}),b.getAllIndicative().then(function(k){a.indicative=k}),b.customfieldselect(a.idContactlist).then(function(k){a.arr=[];for(var l=0;l<k.length;l++)('Select'==k[l].type||'Multiselect'==k[l].type)&&(a.arr[k[l].idCustomfield]=k[l].value);a.progressbar=!0})})},a.changestatus=function(h){b.changestatus(h,a.idContactlist).then(function(k){a.getAll(),d.primary(k.message)})},a.confirmDelete=function(h,k){a.idContact=h,a.idContactlist=k,openModal()},''==f.id?g.go('list'):(a.idForm=f.id,a.getAll()),a.deleteContact=function(){b.deleteContact(a.idContact,a.idContactlist).then(function(h){d.warning(h.message)}),a.getAll(),closeModal()}}]).controller('main',['$rootScope','$scope','$state',function(a,b,d){b.state=d}]).controller('reportController',['$scope','notificationService','restService','$stateParams','constantForms',function(a,b,d,f,g){a.data={},a.misc={show:!0,showList:!0,contactlist:[{}],selected:[],progressbar:!1,changestatus:!0,stringsearch:-1,initial:0,page:1,previewShow:!1,input:[],categoriForm:'',createFor:'',dateCreated:'',numSuscription:'',updateFor:'',updateDate:'',fields:{},total:0,nameForm:'',sizeArrayFields:0,arrayTitlesFil:[],arrayDataContacts:[]},a.functions={searchcontacts:function(){a.misc.stringsearch=a.search,a.resService.suscripsforms(a.idForm)},forward:function(){a.misc.initial+=1,a.misc.page+=1,a.resService.suscripsforms(a.idForm)},fastforward:function(){a.misc.initial=a.contacts[2].total_pages-1,a.misc.page=a.contacts[2].total_pages,a.resService.suscripsforms(a.idForm)},backward:function(){a.misc.initial-=1,a.misc.page-=1,a.resService.suscripsforms(a.idForm)},fastbackward:function(){a.misc.initial=0,a.misc.page=1,a.resService.suscripsforms(a.idForm)},listForms:function(){d.listForms(a.misc.initial,a.filter).then(function(h){a.list=h})},getAllIndicative:function(){d.getAllIndicative().then(function(h){a.indicative=h})},dowloadReport:function(){a.resService.dowloadReport();var h=fullUrlBase+'statistic/downloadexcel/Formulario_'+a.misc.nameForm;location.href=h}},a.resService={dowloadReport:function(){d.dowloadReportContactsForm(a.idForm).then(function(){})},suscripsforms:function(h){d.suscripsforms(h,a.misc.initial,a.misc.stringsearch).then(function(k){a.misc.total=k[1].total,0==k[1].total?(a.loading=!0,a.misc.show=!1,a.misc.showList=!0):(a.loading=!1,a.misc.show=!0,a.misc.showList=!1),null==k[0].items.idContacts?b.warning(g.Notifications.Errors.errorNoneContactsInscriptForms):(a.contacts=k,a.misc.categoriForm=k[0].items.name,a.misc.createFor=k[0].items.createdBy,a.misc.dateCreated=k[0].items.created,a.misc.numSuscription=k[1].total,a.misc.updateFor=k[0].items.updatedBy,a.misc.updateDate=k[0].items.updated,a.fieldsforms=k[3],a.fieldspersonal=k[4].form,a.contactInfoList=k[5].contactsinfo,a.misc.nameForm=k[0].items.nameForm,angular.forEach(a.fieldspersonal,function(l,m){('encabezado'==l.id||'button'==l.id)&&a.fieldspersonal.splice(m,1)}),a.misc.arrayTitlesFil=[],a.misc.sizeArrayFields=a.fieldspersonal.length,angular.forEach(a.fieldspersonal,function(l,m){7<a.misc.sizeArrayFields?3>=m&&a.misc.arrayTitlesFil.push(l):7>=a.misc.sizeArrayFields&&a.misc.arrayTitlesFil.push(l)}),a.arrayAux=[],a.misc.arrayDataContacts=[],angular.forEach(a.contactInfoList,function(l){var n=0;a.aux={},angular.forEach(l,function(o,p){7<a.misc.sizeArrayFields?3>=n&&(a.aux[p]=o):a.aux[p]=o,n++}),a.misc.arrayDataContacts.push(a.aux)})),a.misc.progressbar=!0}).catch(function(k){console.log(k),b.error(k.message)})}},'undefined'!=typeof f.id&&(a.idForm=f.id,a.resService.suscripsforms(a.idForm))}])})();