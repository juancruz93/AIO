(function(){angular.module('automaticcampaign.controllers',[]).filter('getGmtById',function(){return function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c].gmt==b)return a[c];return null}}).controller('createController',['$scope','$rootScope','$q','notificationService','restServices','moment','$filter','$window','$location','$state',function(a,b,c,d,e,f,g,h,k,l){$('#datetimepickerStart').datetimepicker({format:'yyyy-MM-dd hh:mm',language:'es',startDate:new Date}).on('changeDate',function(){a.applyTextGmt(),a.$apply()}),$('#datetimepickerEnd').datetimepicker({format:'yyyy-MM-dd hh:mm',language:'es',startDate:new Date}).on('changeDate',function(){a.applyTextGmt(),a.$apply()}),a.showTextGmtStart=!1,a.showTextGmtEnd=!1;var m=10;a.formCampaign={},a.getServices=function(){e.getservices().then(function(o){a.services=o,a.items=[{class:'item-success-inverted-no-hover small-text text-center',name:'Servicio',icon:!1,iconClass:'fa fa-envelope-o'}];for(var p=0;p<o.length;p++)'sms'==o[p].service&&a.items.push({class:'small-text text-center cursor-pointer',name:'Sms',theme:'service',method:'sms',templatepopover:fullUrlBase+'flowchart/popoversms',titlepopover:'Configurar sms',disabled:!1,icon:!0,iconClass:'fa fa-mobile fa-2x',image:fullUrlBase+'images/automatic/SMSA-01.jpg'}),'email marketing'==o[p].service&&a.items.push({class:'small-text text-center cursor-pointer',name:'Mail',theme:'service',method:'email',templatepopover:fullUrlBase+'flowchart/popovermail',titlepopover:'Configurar correo',disabled:!1,icon:!0,iconClass:'fa fa-envelope-o fa-2x',image:fullUrlBase+'images/automatic/correoa-01.jpg'});a.items.push({class:'item-primary-inverted-no-hover small-text text-center',name:'Operadores',icon:!1,iconClass:'fa fa-envelope-o'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Tiempo',theme:'operator',method:'time',templatepopover:fullUrlBase+'flowchart/popovertime',titlepopover:'Operador por tiempo',disabled:!0,icon:!0,iconClass:'fa fa-clock-o fa-2x',image:fullUrlBase+'images/automatic/tiempoa-01.jpg'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Accion',theme:'operator',method:'actions',templatepopover:fullUrlBase+'flowchart/popoveraction',titlepopover:'Operador por accion',disabled:!0,icon:!0,iconClass:'fa fa-cogs fa-2x',image:fullUrlBase+'images/automatic/accion-01.jpg'}),e.validateService(a.chartViewModel.data,o)}).catch(function(o){a.services=o,a.items=[{class:'item-success-inverted-no-hover small-text text-center  text-center',name:'Servicio',icon:!1,iconClass:'fa fa-envelope-o'}],a.items.push({class:'item-primary-inverted-no-hover small-text text-center  text-center',name:'Operadores',icon:!1,iconClass:'fa fa-envelope-o'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Tiempo',theme:'operator',method:'time',templatepopover:fullUrlBase+'flowchart/popovertime',titlepopover:'Operador por tiempo',disabled:!0,icon:!0,iconClass:'fa fa-clock-o fa-2x',image:fullUrlBase+'images/automatic/tiempoa-01.jpg'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Accion',theme:'operator',method:'actions',templatepopover:fullUrlBase+'flowchart/popoveraction',titlepopover:'Operador por accion',disabled:!0,icon:!0,iconClass:'fa fa-cogs fa-2x',image:fullUrlBase+'images/automatic/accion-01.jpg'})})};var n={nodes:[{name:'Destinatario(s)',id:0,x:170,y:25,width:100,image:fullUrlBase+'images/automatic/destinatariosa-01.jpg',theme:'primary',method:'primary',templatepopover:fullUrlBase+'flowchart/popoversegment',titlepopover:'Selecciona a quien quiere enviar esta campa\xF1a autom\xE1tica.',outputConnectors:[{name:''}],sendData:{}}],connections:[]};a.addNewNode=function(o){if('undefined'!=typeof o.method){var p={name:o.name,id:m++,x:10,y:50,width:100,theme:o.theme,method:o.method,image:o.image,templatepopover:o.templatepopover,titlepopover:o.titletemplate,inputConnectors:[{name:''}],outputConnectors:[{name:''}],sendData:{}};'actions'==o.method&&p.outputConnectors.push({name:''}),a.chartViewModel.addNode(p)}},a.createAutomaticCampaign=function(o){e.validateJsonAutomaticCampaign(a.chartViewModel.data,a.services).then(function(){a.optionCreate=o,1==o?'undefined'==typeof a.idCampaign?e.createAutomaticCampaignDraft(a.chartViewModel.data).then(function(q){d.success(q.message),a.idCampaign=q.idCampaign}):e.updateAutomaticCampaignConfiguration(a.chartViewModel.data,a.idCampaign).then(function(q){d.primary(q.message)}):$('#createAutomaticCampaign').addClass('dialog--open')})},a.toReturn=function(){l.go('index')},a.insCampaign=function(){a.formCampaign.startDate=angular.copy(a.dateGmtStart),a.formCampaign.endDate=angular.copy(a.dateGmtEnd),e.validateFormCampaign(a.formCampaign).then(function(o){var p={formCampaign:o,objCampaign:a.chartViewModel.data};'undefined'==typeof a.idCampaign?e.createAutomaticCampaign(p).then(function(q){d.success(q.message),$('#createAutomaticCampaign').removeClass('dialog--open'),l.go('index')}):e.updateAutomaticCampaignAll(p,a.idCampaign).then(function(q){d.primary(q.message),$('#createAutomaticCampaign').removeClass('dialog--open'),l.go('index')})})},a.getallcategory=function(){e.getallcategory().then(function(o){a.listCategory=o}),e.getGmt().then(function(o){a.listZonaHoraria=o;var p=g('getGmtById')(a.listZonaHoraria,'-0500');a.formCampaign.gmt=p.gmt})},a.getallcategory(),a.applyTextGmt=function(){if(''==$('#datestartCampaign').val()?(a.showTextGmtStart=!1,a.textGmtStart=''):a.showTextGmtStart=!0,''==$('#dateendCampaign').val()?(a.showTextGmtEnd=!1,a.textGmtEnd=''):a.showTextGmtEnd=!0,a.showTextGmtStart){var o=f($('#datestartCampaign').val()).utc().valueOf();a.dateGmtStart=f(o).utcOffset(a.formCampaign.gmt).format('YYYY-MM-DD HH:mm')}if(a.showTextGmtEnd){var p=f($('#dateendCampaign').val()).utc().valueOf();a.dateGmtEnd=f(p).utcOffset(a.formCampaign.gmt).format('YYYY-MM-DD HH:mm')}},a.chartViewModel=new flowchart.ChartViewModel(n),a.getServices()}]).controller('editController',['$scope','$rootScope','$q','$stateParams','restServices','notificationService','$window','$location','$state',function(a,b,c,d,e,f,g,h,k){$('#datetimepickerStart').datetimepicker({format:'yyyy-MM-dd hh:mm',language:'es',startDate:new Date}).on('changeDate',function(){a.applyTextGmt(),a.$apply()}),$('#datetimepickerEnd').datetimepicker({format:'yyyy-MM-dd hh:mm',language:'es',startDate:new Date}).on('changeDate',function(){a.applyTextGmt(),a.$apply()}),a.campaign={},a.formCampaign={},a.complet=!1,'undefined'==typeof d.idautomaticcampaign&&k.go('index'),a.idautomaticcampaign=d.idautomaticcampaign,a.getautomaticcampaign=function(){e.editAutomaticCampaign(a.idautomaticcampaign).then(function(l){a.campaign=l.data.campaign,a.setFormCampaing(l.data.configuration),a.validStatus(a.campaign),a.initTextGmt()}).catch(function(l){null==l.data.configuration&&k.go('index'),a.campaign=l.data.campaign,a.errorCampaign=!0,a.msgErrorCampaign=l.message,a.setFormCampaing(l.data.configuration),a.validStatus(a.campaign),a.initTextGmt()})},a.getautomaticcampaign(),a.validStatus=function(l){'confirmed'==l.status&&$('#updateStatusCampaign').addClass('dialog--open')},a.closeModalStatus=function(){k.go('index')},a.toReturn=function(){k.go('index')},a.updateStatusCampaign=function(){e.updateStatusCampaign(a.idautomaticcampaign).then(function(l){f.primary(l.message),$('#updateStatusCampaign').removeClass('dialog--open')})},a.setFormCampaing=function(l){a.formCampaign=angular.copy(a.campaign),$('#datestartCampaign').val(a.campaign.startDate),$('#dateendCampaign').val(a.campaign.endDate),a.chartViewModel=new flowchart.ChartViewModel(l),a.complet=!0,a.getServices()},a.getServices=function(){e.getservices().then(function(l){a.services=l,a.items=[{class:'item-success-inverted-no-hover small-text text-center',name:'Servicio',icon:!1,iconClass:'fa fa-envelope-o'}];for(var m=0;m<l.length;m++)'sms'==l[m].service&&a.items.push({class:'small-text text-center cursor-pointer',name:'Sms',theme:'service',method:'sms',templatepopover:fullUrlBase+'flowchart/popoversms',titlepopover:'Configurar sms',disabled:!1,icon:!0,iconClass:'fa fa-mobile fa-2x',image:fullUrlBase+'images/automatic/SMSA-01.jpg'}),'email'==l[m].service&&a.items.push({class:'small-text text-center cursor-pointer',name:'Mail',theme:'service',method:'email',templatepopover:fullUrlBase+'flowchart/popovermail',titlepopover:'Configurar correo',disabled:!1,icon:!0,iconClass:'fa fa-envelope-o fa-2x',image:fullUrlBase+'images/automatic/correoa-01.jpg'});a.items.push({class:'item-primary-inverted-no-hover small-text text-center',name:'Operadores',icon:!1,iconClass:'fa fa-envelope-o'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Tiempo',theme:'operator',method:'time',templatepopover:fullUrlBase+'flowchart/popovertime',titlepopover:'Operador por tiempo',disabled:!0,icon:!0,iconClass:'fa fa-clock-o fa-2x',image:fullUrlBase+'images/automatic/tiempoa-01.jpg'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Accion',theme:'operator',method:'actions',templatepopover:fullUrlBase+'flowchart/popoveraction',titlepopover:'Operador por accion',disabled:!0,icon:!0,iconClass:'fa fa-cogs fa-2x',image:fullUrlBase+'images/automatic/accion-01.jpg'}),e.validateService(a.chartViewModel.data,l)}).catch(function(l){a.services=l,a.items=[{class:'item-success-inverted-no-hover small-text text-center  text-center',name:'Servicio',icon:!1,iconClass:'fa fa-envelope-o'}],a.items.push({class:'item-primary-inverted-no-hover small-text text-center  text-center',name:'Operadores',icon:!1,iconClass:'fa fa-envelope-o'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Tiempo',theme:'operator',method:'time',templatepopover:fullUrlBase+'flowchart/popovertime',titlepopover:'Operador por tiempo',disabled:!0,icon:!0,iconClass:'fa fa-clock-o fa-2x',image:fullUrlBase+'images/automatic/tiempoa-01.jpg'}),a.items.push({class:'small-text  text-center cursor-pointer',name:'Accion',theme:'operator',method:'actions',templatepopover:fullUrlBase+'flowchart/popoveraction',titlepopover:'Operador por accion',disabled:!0,icon:!0,iconClass:'fa fa-cogs fa-2x',image:fullUrlBase+'images/automatic/accion-01.jpg'})})},a.getallcategory=function(){e.getallcategory().then(function(l){a.listCategory=l}),e.getGmt().then(function(l){a.listZonaHoraria=l})},a.getallcategory(),a.addNewNode=function(l){if('undefined'!=typeof l.method){var m={name:l.name,id:a.chartViewModel.getIdMax()+1,x:10,y:50,width:100,theme:l.theme,method:l.method,image:l.image,templatepopover:l.templatepopover,titlepopover:l.titletemplate,inputConnectors:[{name:''}],outputConnectors:[{name:''}],sendData:{}};'actions'==l.method&&m.outputConnectors.push({name:''}),a.chartViewModel.addNode(m)}},a.updateAutomaticCampaign=function(l){e.validateJsonAutomaticCampaign(a.chartViewModel.data,a.services).then(function(){a.optionCreate=l,1==l?e.updateAutomaticCampaignConfiguration(a.chartViewModel.data,a.idautomaticcampaign).then(function(n){f.primary(n.message)}):e.validateFormCampaign(a.formCampaign).then(function(n){var o={formCampaign:n,objCampaign:a.chartViewModel.data};e.updateAutomaticCampaignAll(o,a.idautomaticcampaign).then(function(p){f.primary(p.message),k.go('index')})}).catch(function(){a.opeModalUpdateCampaign()})})},a.uptCampaign=function(){a.formCampaign.startDate=angular.copy(a.dateGmtStart),a.formCampaign.endDate=angular.copy(a.dateGmtEnd),e.validateFormCampaign(a.formCampaign).then(function(l){e.updateAutomaticCampaign(l,a.idautomaticcampaign).then(function(m){f.primary(m.message),$('#updateAutomaticCampaign').removeClass('dialog--open')})})},a.initTextGmt=function(){a.showTextGmtStart=!0,a.showTextGmtEnd=!0;var l=moment($('#datestartCampaign').val()).utc().valueOf();a.dateGmtStart=moment(l).format('YYYY-MM-DD HH:mm');var m=moment($('#dateendCampaign').val()).utc().valueOf();a.dateGmtEnd=moment(m).format('YYYY-MM-DD HH:mm')},a.applyTextGmt=function(){if(''==$('#datestartCampaign').val()?(a.showTextGmtStart=!1,a.textGmtStart=''):a.showTextGmtStart=!0,''==$('#dateendCampaign').val()?(a.showTextGmtEnd=!1,a.textGmtEnd=''):a.showTextGmtEnd=!0,a.showTextGmtStart){var l=moment($('#datestartCampaign').val()).valueOf();a.dateGmtStart=moment(l).utcOffset(a.formCampaign.gmt).format('YYYY-MM-DD HH:mm')}if(a.showTextGmtEnd){var m=moment($('#dateendCampaign').val()).valueOf();a.dateGmtEnd=moment(m).utcOffset(a.formCampaign.gmt).format('YYYY-MM-DD HH:mm')}},a.opeModalUpdateCampaign=function(){$('#updateAutomaticCampaign').addClass('dialog--open')}}]).controller('listController',['$scope','restServices','$q','$interval',function(a,b,c,d){a.initial=0,a.page=1,a.filter={},a.listAutomaticCampaign={},a.forward=function(){a.initial+=1,a.page+=1,a.listautocamp()},a.fastforward=function(){a.initial=a.listAutomaticCampaign.total_pages-1,a.page=a.listAutomaticCampaign.total_pages,a.listautocamp()},a.backward=function(){a.initial-=1,a.page-=1,a.listautocamp()},a.fastbackward=function(){a.initial=0,a.page=1,a.listautocamp()},a.listautocamp=function(){a.listAutomaticCampaign.items=[],b.listcampaign(a.initial,a.filter).then(function(g){a.listAutomaticCampaign=g;for(var k,h=0;h<a.listAutomaticCampaign.items.length;h++)(k=a.listAutomaticCampaign.items[h].configuration.configuration,!(angular.isUndefined(k)||'null'==k))&&a.objConfiguration(k,a.listAutomaticCampaign.items[h].idAutomaticCampaign).then(function(l){a.listConfiguration=l})})};a.openModal=function(f){a.idAutCampaign=f,$('#cancelDialog').addClass('dialog--open')},a.closeModal=function(){$('#cancelDialog').removeClass('dialog--open')},a.cancelCampaign=function(){b.cancelAutomaticCampaign(a.idAutCampaign).then(function(f){slideOnTop(f.message,3e3,'glyphicon glyphicon-remove-circle','info'),a.listautocamp()}),a.closeModal()},d(function(){b.listcampaign(a.initial,{}).then(function(g){g.items.forEach(function(h,k){a.listAutomaticCampaign.items[k].status!=h.status&&(a.listAutomaticCampaign.items[k].status=h.status)})})},6e4),a.countContacts=function(f,g,h){b.countContact({type:f,segment:h,contactlist:h}).then(function(l){for(var m=0;m<a.listAutomaticCampaign.items.length;m++)parseInt(a.listAutomaticCampaign.items[m].idAutomaticCampaign)==parseInt(g)&&(a.listAutomaticCampaign.items[m].quantitytarget=l)})},a.objConfiguration=function(f,g){for(var h=c.defer(),k=JSON.parse(f),l=[],m=0;m<k.nodes.length;m++){var n=k.nodes[m],o='';if('primary'==n.method){o=n.sendData.list.name+' : ';for(var p='',q=0;q<n.sendData.selecteds.length;q++)1==n.sendData.list.id?(p='contactlist',a.countContacts(p,g,n.sendData.selecteds),o+=n.sendData.selecteds[q].name+'('+n.sendData.selecteds[q].idContactlist+'),'):(p='segment',a.countContacts(p,g,n.sendData.selecteds),o+=n.sendData.selecteds[q].name+'('+n.sendData.selecteds[q].idSegment+'),');o=o.substring(0,o.length-1),l.push({step:m,detail:o,method:n.method,methodAlias:'Destinatarios'})}'sms'==n.method&&(o='La plantilla de sms : '+n.sendData.smstemplate.name+' con la categoria: '+n.sendData.smscategory.name,l.push({step:m,detail:o,method:n.method,methodAlias:'Sms'})),'email'==n.method&&(o='Plantilla de correo : '+n.sendData.mailtemplate.name+' con la categoria: '+n.sendData.mailcategory.name,l.push({step:m,detail:o,method:n.method,methodAlias:'Correo'})),'time'==n.method&&(o=n.sendData.text,l.push({step:m,detail:o,method:n.method,methodAlias:'Tiempo'})),'actions'==n.method&&(o=n.sendData.text,l.push({step:m,detail:o,method:n.method,methodAlias:'Acci\xF3n'}))}for(var q=0;q<a.listAutomaticCampaign.items.length;q++)parseInt(a.listAutomaticCampaign.items[q].idAutomaticCampaign)==parseInt(g)&&(a.listAutomaticCampaign.items[q].listConfiguration=l);return h.resolve(l),h.promise},a.search=function(){a.listautocamp()},a.searchcategory=function(){a.listautocamp()},a.getCategory=function(){b.getallcategory().then(function(f){a.automaCategory=f})},a.$watch('[filter.dateinitial,filter.dateend]',function(){a.listautocamp()}),a.listautocamp(),a.getCategory()}]).controller('viewschemeController',['$scope','$stateParams','restServices','$q','$interval',function(a,b,c){a.idautomaticcampaign=b.idautomaticcampaign,a.getautomaticcampaign=function(){c.getScheme(a.idautomaticcampaign).then(function(f){a.campaign=f.data.campaign,a.setFormCampaing(f.data.configuration)}).catch(function(f){null==f.data.configuration&&$state.go('index'),a.campaign=f.data.campaign,a.errorCampaign=!0,a.msgErrorCampaign=f.message,a.setFormCampaing(f.data.configuration)})},a.getautomaticcampaign(),a.setFormCampaing=function(f){a.formCampaign=angular.copy(a.campaign),$('#datestartCampaign').val(a.campaign.startDate),$('#dateendCampaign').val(a.campaign.endDate),a.chartViewModel=new flowchart.ChartViewModel(f),a.complet=!0}}])})();